#!/bin/sh

rm /bin/hostname
ln -s /bin/busybox /bin/hostname


echo "--- First boot config ---"

# Hostname
busybox hostname brick

# Networking
rc-update add networking boot

# Ntp
apk add chrony
rc-update add chronyd default

# Ssh
apk add openssh-server
echo "UseDNS no" >> /etc/ssh/sshd_config
rc-update add sshd default
/etc/init.d/sshd checkconfig

# Install additional packages
setup-apkcache /media/mmcblk0p1/cache
apk add /packages/*.apk

# Install brick
mount /media/mmcblk0p1 -o rw,remount
pip3 install --root /media/mmcblk0p1/opt --no-index --find-links=file:/requirements brick
mount /media/mmcblk0p1 -o ro,remount
rc-update add brick boot

# Lbu
setup-lbu -q
# lbu commit -d

# reboot

# TO BE REMOVED
echo "PermitRootLogin yes" >> /etc/ssh/sshd_config
echo "PermitEmptyPasswords yes" >> /etc/ssh/sshd_config
/etc/init.d/networking start
/etc/init.d/chronyd start
sleep 5s
setup-apkrepos -1
